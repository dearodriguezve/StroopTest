<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Test de Stroop con Interferencia</title>
  <style>
    :root{
      --bg:#0f172a;          /* slate-900 */
      --panel:#111827;       /* gray-900 */
      --ink:#e5e7eb;         /* gray-200 */
      --muted:#9ca3af;       /* gray-400 */
      --accent:#22d3ee;      /* cyan-400 */
      --ok:#22c55e;          /* green-500 */
      --bad:#ef4444;         /* red-500 */
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; display:grid; place-items:center; 
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif; 
      background:radial-gradient(1200px 800px at 80% -10%, #172554 0%, transparent 60%),
                 radial-gradient(1000px 600px at -10% 120%, #0e7490 0%, transparent 60%),
                 var(--bg);
      color:var(--ink);
    }
    .app{ width:min(980px, 96vw); }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:24px; padding:28px; box-shadow:0 10px 30px rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
    }
    h1{margin:0 0 8px 0; font-size:clamp(22px, 4vw, 32px); letter-spacing:.3px}
    p{color:var(--muted); line-height:1.6}

    .topbar{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .pill{padding:8px 14px; border:1px solid rgba(255,255,255,.08); border-radius:999px; font-size:14px; color:var(--muted)}
    .progress{height:10px; width:100%; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden}
    .progress>span{display:block; height:100%; background:var(--accent); width:0}

    .stage{
      display:grid; gap:18px; margin-top:18px;
      grid-template-rows:auto auto auto;
    }

    .stimulus{
      display:grid; place-items:center; height:180px; border-radius:18px; border:1px dashed rgba(255,255,255,.18);
      background:rgba(255,255,255,.03);
    }
    .word{font-weight:800; font-size:clamp(42px, 8vw, 72px); letter-spacing:2px; text-transform:uppercase}

    .options{ display:grid; gap:12px; grid-template-columns:repeat(auto-fit, minmax(120px, 1fr)); }
    button.opt{
      font:600 16px/1.2 inherit; padding:14px 16px; border-radius:16px; cursor:pointer; border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04); color:var(--ink); transition:transform .05s ease, background .2s ease, border-color .2s ease;
    }
    button.opt:hover{ transform: translateY(-1px); background:rgba(255,255,255,.07) }
    button.opt:active{ transform: translateY(0) scale(.98) }
    button.opt.correct{ outline:2px solid var(--ok); border-color:rgba(34,197,94,.35) }
    button.opt.incorrect{ outline:2px solid var(--bad); border-color:rgba(239,68,68,.35) }

    .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center; margin-top:6px }
    .btn{
      appearance:none; border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.06); color:var(--ink);
      padding:12px 16px; border-radius:14px; font-weight:700; cursor:pointer;
    }
    .btn.primary{ background:var(--accent); color:#082f49; border-color:transparent }

    .stats{display:flex; gap:16px; flex-wrap:wrap; align-items:center}
    .chip{background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); padding:10px 12px; border-radius:12px; font-size:14px}
    .hint{font-size:13px; color:var(--muted)}

    .hidden{display:none !important}
    .blink{animation:blink .6s ease 2}
    @keyframes blink{50%{opacity:.3}}

    .footer{margin-top:16px; text-align:center; color:var(--muted); font-size:13px}
    kbd{border:1px solid rgba(255,255,255,.25); padding:2px 6px; border-radius:6px; font-size:12px; background:rgba(255,255,255,.08)}

    @media (max-width:480px){ .word{letter-spacing:1px} }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="topbar">
        <h1>Test de Stroop <span style="color:var(--accent)">con Interferencia</span></h1>
        <div class="stats">
          <div class="pill" id="levelPill">Nivel: —</div>
          <div class="pill" id="trialPill">Ensayo: —</div>
          <div class="pill" id="scorePill">Aciertos: 0</div>
        </div>
      </div>

      <p id="intro">
        Selecciona el <strong>color de la tinta</strong> de la palabra (no lo que dice). 
        Hay varios niveles con diferente dificultad e interferencia. 
        Puedes responder haciendo clic o con el teclado (<kbd>1</kbd>-<kbd>9</kbd>).
      </p>

      <div class="progress"><span id="bar"></span></div>

      <section class="stage">
        <div class="stimulus" aria-live="polite" aria-atomic="true">
          <div id="word" class="word">—</div>
        </div>
        <div id="options" class="options"></div>
        <div class="controls">
          <input type="text" id="playerName" placeholder="Nombre del jugador" style="padding:10px; border-radius:8px; border:1px solid #ccc; font-size:16px;"/>
          <button class="btn primary" id="startBtn">Comenzar</button>
          <button class="btn hidden" id="nextBtn">Siguiente nivel</button>
          <button class="btn hidden" id="restartBtn">Reiniciar</button>
          <button class="btn" id="downloadBtn">Descargar resultados</button>
        </div>
      </section>

      <div class="footer" id="foot">Hecho para practicar atención selectiva y control inhibitorio (tarea de Stroop).</div>
    </div>
  </div>

  <script>
(function(){
  // ======= Configuración =======
  const OPTIONS = ["AZUL", "VERDE", "AMARILLO", "ROJO"];
  const COLOR_MAP = {
    "AZUL": "#3b82f6",
    "VERDE": "#22c55e",
    "AMARILLO": "#eab308",
    "ROJO": "#ef4444"
  };

  // ======= Ensayos desde CSV =======
  // Copia los datos del archivo colores.csv aquí:
  const TRIALS = [
    { palabra:"ROJO", color:"AZUL" },
    { palabra:"AMARILLO", color:"VERDE" },
    { palabra:"AZUL", color:"AMARILLO" },
    { palabra:"AZUL", color:"VERDE" },
    { palabra:"AZUL", color:"AMARILLO" },
    { palabra:"AMARILLO", color:"AZUL" },
    { palabra:"ROJO", color:"AMARILLO" },
    { palabra:"AZUL", color:"ROJO" },
    { palabra:"VERDE", color:"AMARILLO" },
    { palabra:"AMARILLO", color:"ROJO" },
    { palabra:"AZUL", color:"VERDE" },
    { palabra:"ROJO", color:"VERDE" },
    { palabra:"VERDE", color:"AZUL" },
    { palabra:"AZUL", color:"AMARILLO" },
    { palabra:"AMARILLO", color:"VERDE" },
    { palabra:"ROJO", color:"AZUL" },
    { palabra:"AZUL", color:"ROJO" },
    { palabra:"AMARILLO", color:"AZUL" },
    { palabra:"VERDE", color:"ROJO" },
    { palabra:"AZUL", color:"ROJO" },
    { palabra:"AZUL", color:"VERDE" },
    { palabra:"VERDE", color:"ROJO" },
    { palabra:"VERDE", color:"AMARILLO" },
    { palabra:"ROJO", color:"VERDE" },
    { palabra:"AMARILLO", color:"AZUL" },
    { palabra:"ROJO", color:"AMARILLO" },
    { palabra:"VERDE", color:"AZUL" },
    { palabra:"AZUL", color:"AMARILLO" },
    { palabra:"AMARILLO", color:"ROJO" },
    { palabra:"VERDE", color:"ROJO" },
    { palabra:"ROJO", color:"AZUL" },
    { palabra:"AMARILLO", color:"VERDE" },
    { palabra:"VERDE", color:"AMARILLO" },
    { palabra:"ROJO", color:"VERDE" },
    { palabra:"AZUL", color:"ROJO" },
    { palabra:"VERDE", color:"AMARILLO" },
    { palabra:"ROJO", color:"AZUL" },
    { palabra:"AMARILLO", color:"ROJO" },
    { palabra:"AZUL", color:"AMARILLO" },
    { palabra:"AMARILLO", color:"ROJO" },
    { palabra:"ROJO", color:"AMARILLO" },
    { palabra:"AMARILLO", color:"AZUL" },
    { palabra:"AZUL", color:"VERDE" },
    { palabra:"ROJO", color:"VERDE" },
    { palabra:"VERDE", color:"AZUL" },
    { palabra:"AZUL", color:"ROJO" },
    { palabra:"AMARILLO", color:"VERDE" },
    { palabra:"VERDE", color:"ROJO" }
  ];

  // ======= Estado =======
  let state = {
    trialIndex: 0,
    score: 0,
    awaiting: false,
    startedAt: 0,
    rts: []
  };

  // ======= Utilidades =======
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  function updatePills(){
    $('#levelPill').textContent = `Nivel único`;
    $('#trialPill').textContent = `Ensayo: ${state.trialIndex+1} / ${TRIALS.length}`;
    $('#scorePill').textContent = `Aciertos: ${state.score}`;
  }

  function setProgress(){
    const pct = Math.min(100, Math.round(((state.trialIndex) / TRIALS.length) * 100));
    $('#bar').style.width = pct + '%';
  }

  function speak(text){
    try{
      if('speechSynthesis' in window){
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'es-ES';
        u.rate = 1.05; u.pitch = .9; u.volume = .35;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
      }
    }catch(e){ /* silencioso */ }
  }

  // ======= Flujo del juego =======
  let playerName = "";
  let allResults = []; // Acumula resultados de todos los jugadores

  function start(){
    playerName = $('#playerName').value.trim();
    if(!playerName){
      $('#playerName').focus();
      $('#playerName').style.borderColor = "#ef4444";
      return;
    }
    $('#playerName').disabled = true;
    $('#playerName').style.borderColor = "#ccc";
    state = { trialIndex: 0, score: 0, awaiting:false, startedAt: 0, rts:[], results:[] };
    $('#intro').innerHTML = `Responde al <strong>color de la tinta</strong>. Evita leer la palabra.`;
    $('#startBtn').classList.add('hidden');
    $('#restartBtn').classList.add('hidden');
    $('#nextBtn').classList.add('hidden');
    nextTrial();
  }

  function endGame(){
    const mean = state.rts.reduce((a,b)=>a+b,0)/Math.max(1,state.rts.length);
    const median = state.rts.slice().sort((a,b)=>a-b)[Math.floor((state.rts.length-1)/2)] || 0;
    const acc = Math.round((state.score/TRIALS.length)*100);

    $('#word').textContent = '¡Listo!';
    $('#word').style.color = 'white';
    $('#options').innerHTML = '';
    $('#intro').innerHTML = `Jugador: <strong>${playerName}</strong><br>Resultados · <strong>Precisión: ${acc}%</strong> · RT medio: <strong>${mean.toFixed(0)} ms</strong> · RT mediana: <strong>${median.toFixed(0)} ms</strong>`;
    $('#restartBtn').classList.remove('hidden');
    speak('Prueba finalizada');
    $('#playerName').disabled = false;

    // Guardar resultados de este jugador
    for(let i=0; i<TRIALS.length; i++){
      allResults.push({
        nombre: playerName,
        ensayo: i+1,
        tiempo: state.rts[i] || '',
        acierto: state.results[i] ? 1 : 0
      });
    }
  }

  function nextTrial(){
    if(state.trialIndex >= TRIALS.length){
      endGame();
      setProgress();
      updatePills();
      return;
    }

    // Construir estímulo desde CSV
    const ensayo = TRIALS[state.trialIndex];
    $('#word').textContent = ensayo.palabra;
    $('#word').style.color = COLOR_MAP[ensayo.color.toUpperCase()] || "#fff";
    $('#word').classList.remove('blink');
    void $('#word').offsetWidth;
    $('#word').classList.add('blink');

    // Opciones fijas
    const optsEl = $('#options');
    optsEl.innerHTML = '';
    OPTIONS.forEach((name, idx)=>{
      const btn = document.createElement('button');
      btn.className = 'opt';
      btn.textContent = `${idx+1}. ${name}`;
      btn.setAttribute('data-color', name);
      btn.title = `Atajo: ${idx+1}`;
      btn.addEventListener('click', ()=> answer(name, btn));
      optsEl.appendChild(btn);
    });

    state.currentTarget = ensayo.color.toUpperCase();
    state.awaiting = true;
    state.startedAt = performance.now();
    setProgress();
    updatePills();
  }

  function answer(choiceName, btn){
    if(!state.awaiting) return;
    state.awaiting = false;

    const rt = Math.max(0, performance.now() - state.startedAt);
    const rtSeconds = (rt / 1000).toFixed(3); // Tiempo en segundos con 3 decimales
    state.rts.push(rt);

    const correct = choiceName === state.currentTarget;
    if(correct){
      state.score++;
    }
    state.results = state.results || [];
    state.results.push(correct);

    // Guardar resultado de este ensayo inmediatamente (tiempo en segundos)
    allResults.push({
      nombre: playerName,
      ensayo: state.trialIndex + 1,
      tiempo: rtSeconds,
      acierto: correct ? 1 : 0
    });

    // Feedback visual
    $$('#options .opt').forEach(b=>{
      b.disabled = true;
      if(b.getAttribute('data-color') === state.currentTarget){ b.classList.add('correct'); }
      if(b === btn && !correct){ b.classList.add('incorrect'); }
    });

    $('#scorePill').textContent = `Aciertos: ${state.score}`;

    setTimeout(()=>{
      state.trialIndex++;
      updatePills();
      nextTrial();
    }, 450);
  }

  // ======= Descargar CSV =======
  function downloadCSV(){
    let csv = "Nombre del jugador;Ensayo;Tiempo;Acierto\n";
    allResults.forEach(r=>{
      csv += `"${r.nombre}";${r.ensayo};${r.tiempo};${r.acierto}\n`;
    });
    const blob = new Blob([csv], {type: "text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "resultados_stroop.csv";
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
  }

  $('#downloadBtn').addEventListener('click', downloadCSV);

  // ======= Interacción =======
  $('#startBtn').addEventListener('click', start);
  $('#restartBtn').addEventListener('click', ()=>{
    $('#playerName').disabled = false;
    start();
  });

  // Atajos de teclado 1..4
  window.addEventListener('keydown', (e)=>{
    const n = parseInt(e.key, 10);
    if(Number.isInteger(n) && n>=1 && n<=4){
      const btn = $(`#options .opt:nth-child(${n})`);
      if(btn){ btn.click(); }
    }
    if(e.key === 'Enter'){
      if(!$('#startBtn').classList.contains('hidden')) start();
    }
  });

  // Mostrar un ejemplo inicial
  (function demo(){
    $('#word').textContent = 'VERDE';
    $('#word').style.color = '#ef4444';
    $('#options').innerHTML = OPTIONS.map((n,i)=>`<button class="opt" disabled>${i+1}. ${n}</button>`).join('');
    updatePills();
    setProgress();
  })();

  // Advertencia y descarga automática al cerrar la pestaña
  window.addEventListener('beforeunload', function (e) {
    if (allResults.length > 0) {
      e.preventDefault();
      e.returnValue = '¿Seguro que quieres salir? Se descargarán los resultados automáticamente.';
    }
  });

  window.addEventListener('unload', function () {
    if (allResults.length > 0) {
      let csv = "Nombre del jugador;Ensayo;Tiempo;Acierto\n";
      allResults.forEach(r=>{
        csv += `"${r.nombre}";${r.ensayo};${r.tiempo};${r.acierto}\n`;
      });
      const blob = new Blob([csv], {type: "text/csv"});
      const url = URL.createObjectURL(blob);

      // Descarga automática (solo funciona en algunos navegadores)
      const a = document.createElement('a');
      a.href = url;
      a.download = "resultados_stroop.csv";
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
    }
  });
})();
  </script>
</body>
</html>
